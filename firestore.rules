rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- FUNCIONES DE APOYO ---
    
    function isSignedIn() {
      return request.auth != null;
    }

    // Verifica si el usuario tiene un documento en /users/ con role 'super_admin'
    function isSuperAdmin() {
      return isSignedIn() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "super_admin";
    }

    // Verifica si el usuario es un 'admin' estándar
    function isAdmin() {
      return isSignedIn() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
    }

    // --- REGLAS POR COLECCIÓN ---

    // 1. COMODÍN TOTAL: El Super Admin puede hacer TODO en CUALQUIER colección
    match /{document=**} {
      allow read, write, delete: if isSuperAdmin();
    }

    // 2. Colección de Usuarios (Gestión de permisos)
    match /users/{userId} {
      // Los usuarios pueden leer su propio perfil, los admins pueden leer todos
      allow read: if isSignedIn() && (request.auth.uid == userId || isAdmin());
      // Solo el Super Admin puede otorgar roles o crear otros admins (cubierto por el comodín de arriba)
    }

    // 3. Colección de Docentes (teachers)
    match /teachers/{teacherId} {
      allow read: if isSignedIn();
      // Solo admins pueden editar, pero no borrar (el super_admin sí puede por el comodín)
      allow create, update: if isAdmin();
    }

    // 4. Colección de Horarios (schedules)
    match /schedules/{scheduleId} {
      allow read: if isSignedIn();
      allow create, update: if isAdmin();
    }

    // 5. Colección de Grupos, Carreras y Materias
    match /groups/{id} { allow read: if isSignedIn(); allow create, update: if isAdmin(); }
    match /programs/{id} { allow read: if isSignedIn(); allow create, update: if isAdmin(); }
    match /subjects/{id} { allow read: if isSignedIn(); allow create, update: if isAdmin(); }

  }
}
