rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- FUNCIONES DE APOYO ---
    
    function isSignedIn() {
      return request.auth != null;
    }

    // Función para obtener los datos del usuario. El `get` se evalúa con los permisos del solicitante.
    // Para que esto funcione, debe haber una regla que permita al usuario leer su propio documento de usuario.
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Verifica si el usuario tiene un documento en /users/ con role 'super_admin'
    function isSuperAdmin() {
      return isSignedIn() && getUserData().role == "super_admin";
    }

    // Verifica si el usuario es un 'admin' estándar
    function isAdmin() {
      return isSignedIn() && getUserData().role == "admin";
    }

    // --- REGLAS POR COLECCIÓN ---

    // Colección de Usuarios (Gestión de permisos)
    match /users/{userId} {
      // REGLA CRÍTICA: Un usuario DEBE poder leer su propio perfil para que las funciones de rol (isSuperAdmin, isAdmin) funcionen sin recursión.
      allow read: if isSignedIn() && request.auth.uid == userId;
      // Admins y Super Admins pueden leer cualquier otro perfil.
      allow read: if isAdmin() || isSuperAdmin();
      // Solo Super Admins pueden crear/editar perfiles (para asignar roles).
      allow write: if isSuperAdmin();
    }

    // Colección de Docentes (teachers)
    match /teachers/{teacherId} {
      // Cualquier usuario autenticado puede leer la lista de docentes.
      allow read: if isSignedIn();
      // Admins y Super Admins pueden crear y actualizar docentes.
      allow create, update: if isAdmin() || isSuperAdmin();
      // Solo Super Admins pueden eliminar docentes.
      allow delete: if isSuperAdmin();
    }

    // Colección de Horarios (schedules)
    match /schedules/{scheduleId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isAdmin() || isSuperAdmin();
    }

    // Colección de Módulos (subjects)
    match /subjects/{subjectId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isAdmin() || isSuperAdmin();
    }
    
    // Colección de Aulas (classrooms)
    match /classrooms/{classroomId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isAdmin() || isSuperAdmin();
    }
    
    // Colección de Carreras (careers)
    match /careers/{careerId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isAdmin() || isSuperAdmin();
    }

    // Colección de Grupos (groups)
    match /groups/{groupId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isAdmin() || isSuperAdmin();
    }
  }
}
